<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Van Savings</title>
</head>

<body>
  <h1>cost of van: <span id="van-cost"></span></h1>
  <h1>amount saved by not renting: <span id="savings"></span></h1>
  <h1>time to break even: <span id="break-even"></span></h1>
  <script>
  (function() {
    const updateIntervalMs = 1000;
    const pingDurationMs = 2000;
    const vanCost = 3800 /* buy */ + 98.2 /* smog */ + 395 /* title */;

    const juneFirst = new Date('2017-06-01 00:00:00 PDT').getTime();
    const msPerSec = 1000;
    const msPerMin = msPerSec * 60;
    const msPerHour = msPerMin * 60;
    const msPerDay = msPerHour * 24;
    const msPerWeek = msPerDay * 7;
    const monthsPerDay = 12 / 365.2425;
    const rent = 1730;
    const carInsurance = 205.88 / 6;
    const dollarsSavedPerMs = (rent - carInsurance) * monthsPerDay / msPerDay;
    const totalMsToBreakEven = Math.round(vanCost / dollarsSavedPerMs);
    const vanCostElement = document.getElementById('van-cost');
    const savingsElement = document.getElementById('savings');
    const breakEvenElement = document.getElementById('break-even');
    const currencyFmt = ['en-US', { style: 'currency', currency: 'USD' }];

    let amtSaved, timeToBreakEven;

    function updateCounters() {
      let msRentFree = Date.now() - juneFirst;
      let newAmtSaved = (msRentFree * dollarsSavedPerMs).toLocaleString(...currencyFmt);
      if (amtSaved != newAmtSaved) {
        amtSaved = newAmtSaved;
        savingsElement.innerText = amtSaved;
        pingGreen(savingsElement, pingDurationMs);
      }

      let msToBreakEven = totalMsToBreakEven - msRentFree;
      if (msToBreakEven > 0) {
        let newTimeToBreakEven = formatMsAsWeeks(msToBreakEven);
        if (timeToBreakEven != newTimeToBreakEven) {
          timeToBreakEven = newTimeToBreakEven;
          breakEvenElement.innerText = timeToBreakEven;
        }
      } else {
        breakEvenElement.innerText = 'NONE!';
      }
    }

    function formatMsAsWeeks(ms) {
      let weeks = Math.floor(ms / msPerWeek);
      let days = Math.floor(ms % msPerWeek / msPerDay);
      let hours = Math.floor(ms % msPerDay / msPerHour);
      let mins = Math.floor(ms % msPerHour / msPerMin);
      let secs = Math.floor(ms % msPerMin / msPerSec);
      return (weeks ? weeks + 'w, ' : '') +
          (days ? days + 'd, ' : '') +
          (hours ? hours + 'h, ' : '') +
          (mins ? mins + 'm, ' : '') +
          (secs + 's');
    }

    function pingGreen(element, ms) {
      let start;
      function step(timestamp) {
        start = start || timestamp;
        let progress = timestamp - start;
        let interpolate255 = Math.floor(255 * (ms - progress) / ms);
        if (interpolate255 > 0) {
          element.style.color = 'rgb(0, ' + interpolate255 + ', 0)';
          window.requestAnimationFrame(step);
        } else {
          element.style.color = '';
        }
      }
      window.requestAnimationFrame(step);
    }

    vanCostElement.innerText = vanCost.toLocaleString(...currencyFmt);
    updateCounters();
    window.setInterval(updateCounters, updateIntervalMs);
  })();
  </script>
</body>

</html>
